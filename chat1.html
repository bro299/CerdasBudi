<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CerdasBudi - Chat Interface with TTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6D28D9',
                        secondary: '#4C1D95',
                        accent: '#8B5CF6',
                        background: '#1F2937',
                        card: '#374151',
                        text: '#F3F4F6',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        .chat-bubble::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 10px 10px 10px 0;
            border-style: solid;
            border-color: transparent #374151 transparent transparent;
        }
        .loader {
            border-top-color: #6D28D9;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tts-loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #6D28D9;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background text-text font-sans dark">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-center">Chat dengan CerdasBudi</h1>
        
        <!-- User Profile Form -->
        <form id="user-profile-form" class="max-w-md mx-auto mb-8 bg-card p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">Buat Profil Anda</h2>
            <div class="mb-6">
                <label for="user-name" class="block text-sm font-medium text-text mb-2">Nama</label>
                <input type="text" id="user-name" name="user-name" required class="w-full px-3 py-2 bg-background border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text">
            </div>
            <div class="mb-6">
                <label for="user-age" class="block text-sm font-medium text-text mb-2">Usia</label>
                <input type="number" id="user-age" name="user-age" required class="w-full px-3 py-2 bg-background border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-text mb-2">Jenis Kelamin</label>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="user-gender" value="laki-laki" required class="form-radio text-primary">
                        <span class="ml-2">Laki-laki</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="user-gender" value="perempuan" required class="form-radio text-primary">
                        <span class="ml-2">Perempuan</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="user-gender" value="lainnya" required class="form-radio text-primary">
                        <span class="ml-2">Lainnya</span>
                    </label>
                </div>
            </div>
            <button type="submit" class="w-full bg-primary text-text font-bold py-3 px-4 rounded-md hover:bg-opacity-80 transition duration-300">
                <i class="fas fa-paper-plane mr-2"></i>Mulai Mengobrol
            </button>
        </form>

        <!-- Chat Interface -->
        <div id="chat-interface" class="max-w-3xl mx-auto bg-card p-6 rounded-lg shadow-lg hidden">
            <div id="chat-messages" class="space-y-4 mb-6 h-96 overflow-y-auto"></div>
            <form id="chat-form" class="flex items-center">
                <input type="text" id="user-input" name="user-input" placeholder="Ketik pesan Anda di sini..." class="flex-grow px-4 py-2 bg-background border border-gray-600 rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary text-text">
                <button type="submit" class="bg-primary text-text px-6 py-2 rounded-r-md hover:bg-opacity-80 transition duration-300">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        let apiKey = '';
        let userName = '';
        let userAge = '';
        let userGender = '';

        const userProfileForm = document.getElementById('user-profile-form');
        const chatInterface = document.getElementById('chat-interface');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');

        async function loadApiKey() {
            try {
                const response = await fetch('.env');
                if (!response.ok) {
                    throw new Error('Gagal memuat file .env');
                }
                const text = await response.text();
                const match = text.match(/API_KEY=(.+)/);
                if (match && match[1]) {
                    apiKey = match[1].trim();
                } else {
                    throw new Error('API key tidak ditemukan di file .env');
                }
            } catch (error) {
                console.error('Error memuat API key:', error);
                await promptForApiKey();
            }
        }

        async function promptForApiKey() {
            const result = await Swal.fire({
                icon: 'info',
                title: 'API Key Diperlukan',
                html: 'Silakan masukkan API key Anda:<br><br>' +
                      'Jika Anda belum memiliki API key, ' +
                      '<a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-accent hover:underline">klik di sini untuk membuatnya</a>.',
                input: 'text',
                inputPlaceholder: 'API key Anda',
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                cancelButtonText: 'Batal',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Anda perlu memasukkan API key!';
                    }
                }
            });

            if (result.isConfirmed) {
                apiKey = result.value;
                await saveApiKey(apiKey);
            } else {
                window.location.href = 'index.html'; // Redirect to home if user cancels
            }
        }

        async function saveApiKey(key) {
            try {
                const response = await fetch('/save-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ apiKey: key }),
                });

                if (!response.ok) {
                    throw new Error('Gagal menyimpan API key');
                }

                Swal.fire({
                    icon: 'success',
                    title: 'API Key Tersimpan',
                    text: 'API key Anda telah berhasil disimpan.',
                });
            } catch (error) {
                console.error('Error menyimpan API key:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Gagal menyimpan API key. Silakan coba lagi.',
                });
            }
        }

        loadApiKey();

        userProfileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            userName = document.getElementById('user-name').value;
            userAge = document.getElementById('user-age').value;
            userGender = document.querySelector('input[name="user-gender"]:checked').value;
            
            userProfileForm.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            
            // Tambahkan pesan selamat datang
            addMessage('ai', `Halo ${userName}! Saya CerdasBudi, psikolog AI Anda. Ceritakan masalah anda!`);
        });

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!apiKey) {
                await promptForApiKey();
                if (!apiKey) return;
            }

            const userMessage = userInput.value;
            addMessage('user', userMessage);
            userInput.value = '';

            const prompt = `
Anda adalah psikolog AI bernama CerdasBudi, yang mengkhususkan diri dalam membantu orang-orang dengan masalah seperti perundungan, ketakutan, rasa malu, dan tantangan kesehatan mental. Gaya komunikasi Anda hangat, mendukung, dan menggunakan bahasa yang sesuai dengan anak muda Indonesia. Tugas Anda adalah:

1. Memberikan respons yang empatik dan mendukung terhadap pesan pengguna.
2. Menawarkan saran praktis dan strategi mengatasi masalah yang disesuaikan dengan situasi mereka.
3. Menyarankan kelompok dukungan atau komunitas yang relevan yang mungkin bermanfaat bagi mereka.
4. Merekomendasikan 5 buku (dengan harga dan deskripsi singkat) yang bisa bermanfaat untuk situasi mereka.
5. Menyarankan 5 lagu relaksasi di YouTube yang sesuai dengan keadaan emosional atau situasi mereka.

Profil Pengguna:
Nama: ${userName}
Usia: ${userAge}
Jenis Kelamin: ${userGender}

Pesan pengguna: ${userMessage}

Berikan respons Anda dengan nada percakapan, menyapa pengguna dengan namanya. Format respons Anda dalam HTML, menggunakan tag yang sesuai untuk struktur (misalnya, <p>, <ul>, <h3>). Untuk rekomendasi buku dan musik, gunakan format berikut:

<h3>Rekomendasi Buku:</h3>
<ul>
    <li>
        <strong>Judul Buku</strong> oleh Penulis - Rp XXX.XXX
        <p>Deskripsi singkat buku.</p>
    </li>
    <!-- Ulangi untuk 5 buku -->
</ul>

<h3>Rekomendasi Musik Relaksasi:</h3>
<ul>
    <li>
        <strong>Judul Lagu</strong> oleh Artis
        <a href="URL_YOUTUBE" target="_blank">Dengarkan di YouTube</a>
    </li>
    <!-- Ulangi untuk 5 lagu -->
</ul>
            `;

            try {
                const response = await generateContent(prompt);
                const result = response.candidates[0].content.parts[0].text;
                addMessage('ai', result);
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Terjadi kesalahan saat memproses permintaan Anda. Silakan coba lagi.',
                });
            }
        });

        async function generateContent(prompt) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) {
                if (response.status === 403) {
                    apiKey = '';
                    throw new Error('API key tidak valid');
                }
                throw new Error('Respons jaringan tidak berhasil');
            }

            return response.json();
        }

        function addMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'items-start', 'space-x-4', 'mb-4');
            
            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('flex-shrink-0', 'w-10', 'h-10', 'rounded-full', 'overflow-hidden');
            
            const avatarImg = document.createElement('img');
            avatarImg.src = sender === 'user' ? 'assets/user.png' : 'assets/aiuserr.png';
            avatarImg.alt = sender === 'user' ? 'User Avatar' : 'AI Avatar';
            avatarImg.classList.add('w-full', 'h-full', 'object-cover');
            
            avatarDiv.appendChild(avatarImg);
            messageDiv.appendChild(avatarDiv);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('flex-grow');
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('bg-card', 'p-4', 'rounded-lg', 'shadow', 'relative', 'chat-bubble');
            
            if (sender === 'user') {
                bubbleDiv.classList.add('bg-primary', 'text-white');
            } else {
                bubbleDiv.classList.add('bg-secondary', 'text-white');
                
                // Add TTS button for AI messages
                const ttsButton = document.createElement('button');
                ttsButton.innerHTML = '<i class="fas fa-volume-up"></i>';
                ttsButton.classList.add('text-white', 'bg-accent', 'hover:bg-opacity-80', 'p-2', 'rounded-full', 'absolute', 'bottom-2', 'right-2');
                ttsButton.addEventListener('click', () => handleTTS(message));
                bubbleDiv.appendChild(ttsButton);
            }
            
            bubbleDiv.innerHTML += message;
            contentDiv.appendChild(bubbleDiv);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Animate new message
            gsap.from(messageDiv, {duration: 0.5, opacity: 0, y: 20, ease: 'power2.out'});
        }

        async function handleTTS(text) {
            try {
                // Show loading animation
                const loadingDiv = document.createElement('div');
                loadingDiv.classList.add('tts-loader', 'my-2');
                chatMessages.appendChild(loadingDiv);

                // Scroll to bottom to show loading animation
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Call TTS API
                const response = await fetch(`https://api.nyxs.pw/tools/tts?text=${encodeURIComponent(text)}&to=id`);
                const data = await response.json();

                if (data.status) {
                    // Remove loading animation
                    loadingDiv.remove();

                    // Create audio element and play
                    const audio = new Audio(data.result);
                    audio.play();
                } else {
                    throw new Error('TTS API request failed');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Terjadi kesalahan saat memproses TTS. Silakan coba lagi.',
                });
            }
        }
    </script>
</body>
</html>
